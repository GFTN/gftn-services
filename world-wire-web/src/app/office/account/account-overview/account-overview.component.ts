// Â© Copyright IBM Corporation 2020. All rights reserved.
// SPDX-License-Identifier: Apache2.0
// 
import { Component, OnInit } from '@angular/core';
import { SessionService } from '../../../shared/services/session.service';
import { IInstitution } from '../../../shared/models/participant.interface';
import { AuthService } from '../../../shared/services/auth.service';
import { UtilsService } from '../../../shared/utils/utils';
import { MatDialog } from '@angular/material/dialog';
import { ManageParticipantDialogComponent } from '../../accounts/manage-participant-dialog/manage-participant-dialog.component';
import { IInstitutionManageData } from '../../accounts/accounts.component';
import { ParticipantsModel } from '../../../shared/models/participants.model';
import { Router } from '@angular/router';

// TODO: Use @carbon-icons
// import UserGroupIcon from '@carbon/icons/es/group/32';
// import { toString } from '@carbon/icon-helpers';

export interface AccountTool {
  title: string;
  link: string;
  icon: string;
}

@Component({
  selector: 'app-account-overview',
  templateUrl: './account-overview.component.html',
  styleUrls: ['./account-overview.component.scss'],
  providers: [
    ParticipantsModel
  ]
})
export class AccountOverviewComponent implements OnInit {

  accountTools: AccountTool[];

  institution: IInstitution;

  iconAttrs = {
    xmlns: 'http://www.w3.org/2000/svg',
    viewBox: '0 0 32 32',
    width: 64,
    height: 64,
    class: 'icon'
  };

  constructor(
    private router: Router,
    public dialog: MatDialog,
    private sessionService: SessionService,
    private authService: AuthService,
    public _participants: ParticipantsModel,
    public utils: UtilsService
  ) {
    this.institution = this.sessionService.institution;
  }

  ngOnInit() {

    if (this.institution) {
      // init tools and icons
      this.accountTools = [
        {
          title: 'Manage Accounts',
          link: '/portal/' + this.institution.info.slug + '/accounts',
          // tslint:disable-next-line: max-line-length
          icon: `<svg width="100%" viewBox="0 0 53 52"><title>Account Icon</title><g id="Account-Icon" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><path d="M51.7674419,44.3040524 L50.18616,44.3040524 C50.0588958,42.44148 49.1520136,40.7933551 47.7861789,39.6909137 C47.7982038,39.6234583 47.8262621,39.5630506 47.8262621,39.4925749 L47.8262621,19.062673 C48.8844583,18.1938082 49.6570618,16.9947143 50.0027794,15.6234583 L47.4124031,15.6234583 C46.7981282,17.0510949 45.3841936,18.0528568 43.7407828,18.0528568 C42.0963698,18.0528568 40.6824352,17.0510949 40.0671583,15.6234583 L37.4777841,15.6234583 C37.8224995,16.9937075 38.595103,18.1938082 39.6543014,19.062673 L39.6543014,39.4925749 C39.6543014,39.5640574 39.6823596,39.6244651 39.6933825,39.6919205 C38.3285498,40.7953687 37.4226697,42.4424868 37.2954056,44.3040524 L32.9463793,44.3040524 C32.8181131,42.44148 31.9122329,40.7933551 30.5463982,39.6909137 C30.5514086,39.659703 30.5604273,39.6315127 30.5634335,39.6013088 C34.6168463,37.9733199 37.4908111,33.9954694 37.4908111,29.3491065 C37.4908111,24.7118047 34.6268671,20.7379814 30.5854793,19.1049585 L30.5854793,19.062673 C31.6436756,18.1938082 32.4172811,16.9947143 32.7629987,15.6234583 L30.1726224,15.6234583 C29.5573454,17.0510949 28.1434109,18.0528568 26.5010021,18.0528568 C24.8565891,18.0528568 23.4426546,17.0510949 22.8273776,15.6234583 L20.2380034,15.6234583 C20.5827189,16.9937075 21.3553224,18.1938082 22.4145207,19.062673 L22.4145207,19.1039517 C18.3721308,20.7379814 15.5081868,24.7107979 15.5081868,29.3491065 C15.5081868,33.9954694 18.3821516,37.9733199 22.4355644,39.6013088 C22.4385706,39.6325195 22.4485914,39.6607098 22.4536018,39.6919205 C21.0887691,40.7953687 20.182889,42.4424868 20.0556249,44.3040524 L15.7055965,44.3040524 C15.5783324,42.44148 14.6724523,40.7933551 13.3066175,39.6909137 C13.3166383,39.6234583 13.3456986,39.5630506 13.3456986,39.4925749 L13.3456986,19.062673 C14.4038949,18.1938082 15.1764984,16.9947143 15.5222159,15.6234583 L12.9328417,15.6234583 C12.3165627,17.0510949 10.9036302,18.0528568 9.2612214,18.0528568 C7.61580639,18.0528568 6.20187181,17.0510949 5.5875969,15.6234583 L2.99722065,15.6234583 C3.34193609,16.9937075 4.11554169,18.1938082 5.17273587,19.062673 L5.17273587,39.4925749 C5.17273587,39.5640574 5.20179618,39.6244651 5.21281906,39.6919205 C3.84898847,40.7953687 2.94210626,42.4424868 2.81484213,44.3040524 L1.23255814,44.3040524 C0.551143884,44.3040524 0,44.8567833 0,45.5414045 L0,50.7626479 C0,51.4452555 0.551143884,52 1.23255814,52 L51.7674419,52 C52.447854,52 53,51.4452555 53,50.7626479 L53,45.5414045 C53,44.8567833 52.447854,44.3040524 51.7674419,44.3040524 Z M42.1184156,20.3131135 C42.6374929,20.449031 43.1796181,20.5285678 43.7407828,20.5285678 C44.3009454,20.5285678 44.8420684,20.449031 45.3621479,20.3131135 L45.3621479,38.4696703 C44.8420684,38.3347596 44.3009454,38.2552228 43.7407828,38.2552228 C43.1796181,38.2552228 42.6374929,38.3347596 42.1184156,38.4706771 L42.1184156,20.3131135 Z M43.7407828,40.7309338 C45.7960484,40.7309338 47.47353,42.298515 47.7,44.3040524 L39.7825676,44.3040524 C40.0080355,42.298515 41.6865192,40.7309338 43.7407828,40.7309338 Z M17.972301,29.3491065 C17.972301,24.6161591 21.7882208,20.7812736 26.4989979,20.7812736 C31.2107771,20.7812736 35.0266969,24.6161591 35.0266969,29.3491065 C35.0266969,34.0790335 31.2107771,37.9169393 26.4989979,37.9169393 C21.7882208,37.9169393 17.972301,34.0790335 17.972301,29.3491065 Z M30.4592172,44.3040524 L22.5417848,44.3040524 C22.7672528,42.298515 24.4457364,40.7309338 26.5010021,40.7309338 C28.5552656,40.7309338 30.2337493,42.298515 30.4592172,44.3040524 Z M7.63785215,20.3131135 C8.15793156,20.449031 8.69905464,20.5285678 9.2612214,20.5285678 C9.82038192,20.5285678 10.3625071,20.449031 10.8815844,20.3131135 L10.8815844,38.4696703 C10.3625071,38.3347596 9.82038192,38.2552228 9.2612214,38.2552228 C8.69905464,38.2552228 8.15793156,38.3347596 7.63785215,38.4706771 L7.63785215,20.3131135 Z M9.2612214,40.7309338 C11.315485,40.7309338 12.9939686,42.298515 13.2194366,44.3040524 L5.30200416,44.3040524 C5.52747211,42.298515 7.20595576,40.7309338 9.2612214,40.7309338 Z M2.4641142,49.5252957 L50.5358858,49.5252957 L50.5358858,46.7797634 L2.4641142,46.7797634 L2.4641142,49.5252957 Z M52.9298544,7.20261767 C52.9158253,7.16335263 52.8887691,7.13214196 52.8707317,7.09489051 C52.8296464,7.00830607 52.7925695,6.92172162 52.7344489,6.84721873 C52.7023823,6.8059401 52.6582908,6.77875661 52.6212138,6.74251196 C52.5610891,6.683111 52.5069767,6.62068966 52.4358291,6.57538384 C52.3857251,6.54215958 52.3235961,6.52605084 52.2674797,6.50088095 C52.2013424,6.47168387 52.1402155,6.43040524 52.0670637,6.41228291 L26.8006239,0.0372514473 C26.7024201,0.0120815505 26.6012101,0 26.5010021,0 C26.4969938,0 26.4939875,0.00201359174 26.4899792,0.00201359174 C26.3937795,0.00201359174 26.2975799,0.0130883463 26.2043865,0.0372514473 L0.931934203,6.41228291 C0.859784458,6.43040524 0.797655511,6.47168387 0.731518245,6.50088095 C0.675401777,6.52605084 0.61427491,6.54215958 0.563168841,6.57538384 C0.493023256,6.62068966 0.437908867,6.683111 0.37778408,6.74251196 C0.341709208,6.77875661 0.296615617,6.8059401 0.264549064,6.84721873 C0.207430516,6.92172162 0.169351484,7.00830607 0.129268293,7.09489051 C0.111230856,7.13214196 0.0831726224,7.16335263 0.0701455852,7.20261767 C0.0250519947,7.33148754 0,7.47042537 0,7.61339039 L0,11.9093884 C0,12.5940096 0.551143884,13.1467405 1.23255814,13.1467405 L51.7674419,13.1467405 C52.447854,13.1467405 53,12.5940096 53,11.9093884 L53,7.61339039 C53,7.47042537 52.974948,7.33148754 52.9298544,7.20261767 Z M50.5358858,10.6710294 L2.4641142,10.6710294 L2.4641142,8.57890763 L26.5010021,2.51497609 L50.5358858,8.57890763 L50.5358858,10.6710294 Z M25.6301947,5.84042285 C25.3987143,6.0729927 25.2634335,6.39315379 25.2634335,6.72338283 C25.2634335,7.04354392 25.3987143,7.36370501 25.6301947,7.59728165 C25.8626773,7.8298515 26.1723199,7.95570098 26.5,7.95570098 C26.8186614,7.95570098 27.1373227,7.8298515 27.3698053,7.59728165 C27.6012857,7.36370501 27.7265457,7.04354392 27.7265457,6.72338283 C27.7265457,6.39315379 27.6012857,6.0729927 27.3698053,5.84948402 C26.9158631,5.38333753 26.0751182,5.38333753 25.6301947,5.84042285 Z M27.341747,34.1193053 C28.1594441,33.9692927 28.8218189,33.6873899 29.3098317,33.2584948 C29.8860276,32.7530833 30.1836453,32.1006796 30.1836453,31.3294739 C30.1836453,30.8321168 30.0764228,30.4002014 29.8609756,30.0387616 C29.6495368,29.6853763 29.3248629,29.3783035 28.8889582,29.1094891 C28.5292116,28.8890008 28.0171488,28.6675057 27.341747,28.4419834 L27.341747,28.4379562 L25.6732842,27.8187767 L25.6732842,27.8389127 C25.6271885,27.8167632 25.5891095,27.7936068 25.5490263,27.7774981 L25.5410096,27.7724641 C25.3415958,27.6576894 25.2173379,27.566071 25.1461902,27.4895545 C24.9968803,27.3324943 24.9197202,27.1230808 24.9197202,26.8421847 C24.9197202,26.6076013 25.0028928,26.4233577 25.1742484,26.2592499 C25.2083192,26.2310597 25.244394,26.2089101 25.2784647,26.1877674 L25.2784647,26.1787063 C25.2784647,26.1787063 25.7253923,25.6924239 27.341747,25.9048578 C27.3587824,25.9048578 27.3728115,25.9068714 27.3888448,25.9108986 C27.5371526,25.9330481 27.6984874,25.9551976 27.8628285,25.9904354 C27.9520136,26.007551 28.0171488,26.0327209 28.0892985,26.0448024 C28.4229911,26.1273597 28.747665,26.2280393 29.0763471,26.3559023 C29.2557194,26.4324188 29.4671583,26.33778 29.5423142,26.1535364 L29.9251087,25.1870123 C29.9952543,24.9987415 29.9060692,24.7913416 29.7196824,24.7148251 C28.961108,24.4037251 28.1594441,24.2164611 27.341747,24.1631009 L27.341747,23.1784546 C27.341747,22.9760886 27.1754018,22.8160081 26.9860087,22.8160081 L26.035035,22.8160081 C25.8326149,22.8160081 25.6732842,22.9760886 25.6732842,23.1784546 L25.6732842,24.2053864 C24.9327472,24.330229 24.3114577,24.591996 23.8344678,24.9947143 C23.2492532,25.474956 22.9536396,26.1082306 22.9536396,26.8603071 C22.9536396,27.620438 23.1951409,28.2597533 23.6651163,28.7470425 C24.0469087,29.1487541 24.6521649,29.4930783 25.4838911,29.7961238 L27.341747,30.436446 C27.7175269,30.5965266 27.9009075,30.7314372 27.9930989,30.8250692 C28.145415,30.9730682 28.2145585,31.1673798 28.2145585,31.4210924 C28.2145585,31.6254719 28.2145585,32.1037 27.341747,32.340297 C27.341747,32.340297 26.6723577,32.547697 25.6732842,32.4772212 C25.6492343,32.478228 25.6271885,32.4711805 25.6021365,32.4711805 C25.5840991,32.4671533 25.5530346,32.4671533 25.532993,32.4671533 C25.5029306,32.4671533 25.4838911,32.4601057 25.4538287,32.4560785 C25.2013046,32.4329222 24.9397618,32.38963 24.6571753,32.3282155 C24.1591416,32.2204883 23.7072036,32.0734961 23.3254112,31.9053612 C23.2151825,31.8610622 23.0869162,31.8650894 22.9816979,31.9325447 C22.8814899,32 22.8173568,32.1177951 22.8173568,32.2355902 L22.8173568,33.3903851 C22.8173568,33.5263025 22.9005294,33.657186 23.0267915,33.7155802 C23.3795235,33.8817015 23.8354698,34.0095646 24.3816033,34.1021898 C24.7964644,34.1716587 25.2323691,34.2179713 25.6732842,34.2280393 L25.6732842,35.5187516 C25.6732842,35.719104 25.8326149,35.8811981 26.035035,35.8811981 L26.9860087,35.8811981 C27.1754018,35.8811981 27.341747,35.719104 27.341747,35.5187516 L27.341747,34.1193053 Z" fill="#43474D"></path>
              </g>
          </svg>`
        },
        {
          title: 'Manage Users',
          link: '/portal/' + this.institution.info.slug + '/users',
          icon: `<svg width="100%" viewBox="0 0 33 30">
                <g fill="none" fill-rule="evenodd" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" transform="translate(.2 .4)">
                  <path stroke-width=".866" d="M25.17 29.15v-5.97c0-4.2-2.9-7.71-6.82-8.64a5.06 5.06 0 1 0-4.11 0 8.89 8.89 0 0 0-6.83 8.64v5.97"/>
                  <path stroke-width=".866" d="M32.15 24.35v-5.97c0-4.2-2.91-7.71-6.83-8.64a5.06 5.06 0 1 0-7.12-4.62M.43 24.35v-5.97c0-4.2 2.92-7.71 6.83-8.64a5.06 5.06 0 1 1 7.12-4.62"/>
                </g>
              </svg>`
          // TODO: Use @carbon-icons
          // icon: toString({
          //   ...UserGroupIcon,
          //   attrs: this.iconAttrs
          // })
        },
        {
          title: 'Manage Billing',
          link: '',
          icon: `<svg width="100%" viewBox="0 0 33 33">
                <g fill="none" fill-rule="evenodd" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" transform="translate(.5 .2)">
                  <path stroke-width=".866" d="M26.74 24.22V1.74c0-.72-.58-1.3-1.3-1.3H1.46c-.72 0-1.3.58-1.3 1.3v27.82a2.6 2.6 0 0 0 2.67 2.59 2.67 2.67 0 0 0 2.51-2.7v-3.93c0-.72.59-1.3 1.3-1.3h23.93c.72 0 1.3.58 1.3 1.3v4.04a2.6 2.6 0 0 1-2.6 2.59H2.75"/>
                  <polygon stroke-width=".866" points="3.831 8.613 23.435 8.613 23.435 3.671 3.831 3.671"/>
                  <path stroke-width=".866" d="M14.04 20.6h9.4m-9.4-2.84h9.4m-9.4-2.85h9.4m-9.4-2.84h9.4"/>
                  <polygon stroke-width=".866" points="3.831 20.601 11.339 20.601 11.339 11.981 3.831 11.981"/>
                </g>
              </svg>`
        },
        {
          title: 'Manage Nodes',
          link: '/office/account/' + this.institution.info.slug + '/nodes',
          // tslint:disable-next-line: max-line-length
          icon: `<svg width="100%" viewBox="0 0 21 24"><path d="M9.5 1c.9 0 1.5.7 1.5 1.5S10.4 4 9.5 4C8.7 4 8 3.3 8 2.5S8.7 1 9.5 1zm0-1C8.2 0 7 1.1 7 2.5S8.2 5 9.5 5 12 3.9 12 2.5 10.9 0 9.5 0zM17 4l-3 1.7v2.4L10.3 6 5 9v3.6l-2-1.1-3 1.7v3.5l3 1.7 3-1.7v-1.1l4.5 2.4 5-3v-4.9l1.5.9 3-1.7V5.8L17 4zm-6.7 3.2l3.8 2.1-3.5 1.8-4-1.8 3.7-2.1zM5 16.1l-2 1.2-2-1.1v-2.3l2-1.2 2 1.1v2.3zm1-5.9l4 1.8v4.6l-4-2.2v-4.2zm5 6.3V12l3.5-1.8v4.2L11 16.5zm8-7.8l-2 1.2-2-1.2V6.3l2-1.2 2 1.2v2.4zM2.5 4C3.4 4 4 4.7 4 5.5S3.4 7 2.5 7 1 6.3 1 5.5 1.7 4 2.5 4zm0-1C1.1 3 0 4.1 0 5.5S1.1 8 2.5 8 5 6.9 5 5.5 3.9 3 2.5 3zm9 17c.8 0 1.5.7 1.5 1.5s-.6 1.5-1.5 1.5-1.5-.7-1.5-1.5.7-1.5 1.5-1.5zm0-1C10.1 19 9 20.1 9 21.5s1.1 2.5 2.5 2.5 2.5-1.1 2.5-2.5-1.1-2.5-2.5-2.5zm7-3c.8 0 1.5.7 1.5 1.5s-.7 1.5-1.5 1.5-1.5-.7-1.5-1.5.7-1.5 1.5-1.5zm0-1c-1.4 0-2.5 1.1-2.5 2.5s1.1 2.5 2.5 2.5 2.5-1.1 2.5-2.5-1.1-2.5-2.5-2.5z"></path></svg>`
        },
        {
          title: 'Manage Payout Points',
          link: '',
          icon: `<svg width="100%" viewBox="0 0 33 33">
                <g fill="none" fill-rule="evenodd" stroke="#000000" stroke-linejoin="round">
                  <path stroke-width=".866" d="M26.3 29.04H19c-1.67 0-2.35-.97-2.35-2.27V5.81c0-1.3.68-2.27 2.35-2.27h7.3M7 16.3H26.3"/>
                  <path stroke-linecap="round" stroke-width=".866" d="M32.5 3.54a3.1 3.1 0 1 0-6.2 0 3.1 3.1 0 0 0 6.2 0zm0 12.75a3.1 3.1 0 1 0-6.2 0 3.1 3.1 0 0 0 6.2 0zm-25.49 0a3.1 3.1 0 1 0-6.22 0 3.1 3.1 0 0 0 6.22 0zm25.5 12.75a3.1 3.1 0 1 0-6.22 0 3.1 3.1 0 0 0 6.22 0z"/>
                </g>
              </svg>`
        }
      ];
    }
  }

  refreshInstitution() {
    this._participants
      .get(this.institution.info.institutionId)
      .then((institution: IInstitution) => {
        if (institution.info.slug !== this.institution.info.slug) {

          // refresh session
          this.sessionService.institution = institution;

          // force page refresh to reroute with new slug
          this.router.navigate([`/office/account/${institution.info.slug}`]);
        }

        // refresh current view
        this.institution = institution;
      });
  }

  editParticipant(institution: IInstitution) {
    // set institution id by slug
    // const institutionId = this.slugInstitutionIdMap[institution.slug];
    this.openParticipantDialog('edit', institution);
  }


  private openParticipantDialog(action: 'add' | 'edit', institution?: IInstitution) {

    const data: IInstitutionManageData = {
      action: action,
      institution: institution,
    };

    const dialogRef = this.dialog.open(ManageParticipantDialogComponent, {
      disableClose: true,
      data: data
    });

    dialogRef.afterClosed().subscribe(result => {
      console.log('Participant dialog was closed');
      this.refreshInstitution();
    });
  }



  /**
   * Toggles disabling of action buttons if user does or does not
   * have the proper super permissions to utilize that action
   *
   * @param {string[]} superPermission
   * @returns
   * @memberof AccountOverviewComponent
   */
  public hasSuperPermissions(superPermission: string[]) {
    // check if super permissions exist
    if (this.authService.hasSpecificSuperPermissions(this.authService.userProfile, superPermission)) {
      return true;
    }

    return false;
  }
}
